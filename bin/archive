#!/bin/bash

set -eo pipefail
[ ! -z "${TRACE:-}" ] && set -x

log() {
  echo "* [${2:-INFO}] $1"
}

die() {
  log >&2 "$1" "ERROR"
  exit 1
}

usage() {
  echo """
  usage: $0 [-p <project>] [-e <environment>] [-l <layer>] <action>
    where
      -p project name (defaults to TF_VAR_project env var)
      -e environment name (defaults to TF_VAR_environment env var)
      -l layer (defaults to TF_VAR_layer env var)
      action is one of 'check', 'create', 'retrieve', 'update', or 'delete'
  """
}

check_args() {
  if [ -z "$project" ] || \
     [ -z "$environment" ] || \
     [ -z "$layer" ] || \
     [ -z "$action" ]; then
    usage
    die 'need args'
  fi
}

check_ansible_archive() {
  local object_url=$1
  gsutil ls ${object_url} | grep -qs ansible
}

remove_ansible_archive() {
  local key=$1
  gsutil rm ${object_url} \
    || die "unable to remove ansible archive ${object_url}"
}

publish_ansible_archive() {
  local tarball_path=$1
  local key=$2
  gsutil cp $tarball_path ${object_url} \
    || die "Unable to publish ansible archive to ${object_url}"
}

create_ansible_archive() {
  local tarball_path=$1
  local project_dir=$(git rev-parse --show-toplevel)
  cd ${project_dir}/terraform/provision
  tar czf $tarball_path --exclude=tmp ansible
}

archive_ansible() {
  local proto="gs"
  local state_bucket="${TF_VAR_stack_state_bucket}"
  local key="infrastructure/${project}/${environment}/ansible/ansible.tar.gz"
  local object_url="${proto}://${state_bucket}/${key}"

  if [ -n "$update_archive" ]; then
    remove_ansible_archive $object_url
  fi

  if ! check_ansible_archive $object_url; then
    local tempfile=$(mktemp -p"/tmp" ansible-XXXXXX.tar.gz)
    create_ansible_archive $tempfile
    publish_ansible_archive $tempfile $object_url
    rm -f $tempfile
  fi
}


main() {

  while getopts ':p:e:l:' OPT; do
    case $OPT in
      p) project_opt=$OPTARG ;;
      e) environment_opt=$OPTARG ;;
      l) layer_opt=$OPTARG ;;
    esac
  done
  project=${project_opt:-$TF_VAR_project} # opt overrides env default
  environment=${environment_opt:-$TF_VAR_environment} # opt overrides env default
  layer=${layer_opt:-$TF_VAR_layer} # opt overrides env default

  shift $(($OPTIND - 1))
  action=$1
  check_args

  case $action in
    *)
      archive_ansible
      ;;
  esac

}

main "$@"
